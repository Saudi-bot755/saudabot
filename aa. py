from flask import Flask, request
from twilio.twiml.messaging_response import MessagingResponse
import time

app = Flask(__name__)
state = {}

@app.route("/bot", methods=["POST"])
def bot():
    incoming_msg = request.values.get('Body', '').strip().lower()
    sender = request.values.get('From')
    resp = MessagingResponse()
    msg = resp.message()

    if sender not in state:
        state[sender] = "init"

    if incoming_msg == "Ø¥Ù„ØºØ§Ø¡":
        msg.body("âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ø§Ø±Ø³Ù„ 'Ø³Ø¹ÙˆØ¯Ø©' Ù„Ù„Ø¨Ø¯Ø¡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
        state[sender] = "init"
    elif state[sender] == "init" and incoming_msg == "Ø³Ø¹ÙˆØ¯Ø©":
        msg.body("ğŸ¤– Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©:")
        state[sender] = "id_requested"
    elif state[sender] == "id_requested":
        state[sender] = {"id": incoming_msg}
        msg.body("ğŸ” Ø£Ø±Ø³Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:")
        state[sender]["next"] = "pass_requested"
    elif isinstance(state[sender], dict) and state[sender].get("next") == "pass_requested":
        state[sender]["pass"] = incoming_msg
        msg.body("ğŸ“© Ø£Ø±Ø³Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø±Ø³Ù„ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹:")
        state[sender]["next"] = "code_requested"
    elif isinstance(state[sender], dict) and state[sender].get("next") == "code_requested":
        code = incoming_msg
        state[sender]["code"] = code
        msg.body("ğŸ“„ Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø³Ø¹ÙˆØ¯Ø© Ø¨Ø±Ø§ØªØ¨ 4000 ÙˆØ§Ù„Ù…Ù‡Ù†Ø© Ù…Ø­Ø§Ø³Ø¨...")
        time.sleep(2)
        msg.body("âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø³Ø¹ÙˆØ¯Ø©.\nğŸ’¼ Ø§Ù„Ù…Ù‡Ù†Ø©: Ù…Ø­Ø§Ø³Ø¨\nğŸ’° Ø§Ù„Ø±Ø§ØªØ¨: 4000\nğŸ“¸ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø§Ù„Ø´Ø§Ø´Ø©.")
        state[sender] = "done"
    elif state[sender] == "done":
        msg.body("ğŸ¤– Ø£Ø±Ø³Ù„ 'Ø³Ø¹ÙˆØ¯Ø©' Ù„Ù„Ø¨Ø¯Ø¡ Ø£Ùˆ 'Ø¥Ù„ØºØ§Ø¡' Ù„Ù„ØªØ±Ø§Ø¬Ø¹.")
    else:
        msg.body("ğŸ¤– Ø£Ø±Ø³Ù„ 'Ø³Ø¹ÙˆØ¯Ø©' Ù„Ù„Ø¨Ø¯Ø¡ Ø£Ùˆ 'Ø¥Ù„ØºØ§Ø¡' Ù„Ù„ØªØ±Ø§Ø¬Ø¹.")
    return str(resp)

@app.route("/", methods=["GET"])
def index():
    return "Saudabot is running!"

if __name__ == "__main__":
    app.run(debug=True)
