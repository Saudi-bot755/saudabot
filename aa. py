from flask import Flask, request
from twilio.twiml.messaging_response import MessagingResponse
import time

app = Flask(__name__)
state = {}

@app.route("/bot", methods=["POST"])
def bot():
    incoming_msg = request.values.get('Body', '').strip().lower()
    sender = request.values.get('From')
    resp = MessagingResponse()
    msg = resp.message()

    if sender not in state:
        state[sender] = "init"

    if incoming_msg == "إلغاء":
        msg.body("❌ تم إلغاء العملية. ارسل 'سعودة' للبدء مرة أخرى.")
        state[sender] = "init"
    elif state[sender] == "init" and incoming_msg == "سعودة":
        msg.body("🤖 أرسل رقم الهوية:")
        state[sender] = "id_requested"
    elif state[sender] == "id_requested":
        state[sender] = {"id": incoming_msg}
        msg.body("🔐 أرسل كلمة المرور:")
        state[sender]["next"] = "pass_requested"
    elif isinstance(state[sender], dict) and state[sender].get("next") == "pass_requested":
        state[sender]["pass"] = incoming_msg
        msg.body("📩 أرسل كود التحقق المرسل من الموقع:")
        state[sender]["next"] = "code_requested"
    elif isinstance(state[sender], dict) and state[sender].get("next") == "code_requested":
        code = incoming_msg
        state[sender]["code"] = code
        msg.body("📄 جاري تنفيذ السعودة براتب 4000 والمهنة محاسب...")
        time.sleep(2)
        msg.body("✅ تم تنفيذ السعودة.\n💼 المهنة: محاسب\n💰 الراتب: 4000\n📸 سيتم إرسال صورة الشاشة.")
        state[sender] = "done"
    elif state[sender] == "done":
        msg.body("🤖 أرسل 'سعودة' للبدء أو 'إلغاء' للتراجع.")
    else:
        msg.body("🤖 أرسل 'سعودة' للبدء أو 'إلغاء' للتراجع.")
    return str(resp)

@app.route("/", methods=["GET"])
def index():
    return "Saudabot is running!"

if __name__ == "__main__":
    app.run(debug=True)
